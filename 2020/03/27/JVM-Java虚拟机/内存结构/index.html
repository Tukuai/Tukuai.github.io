<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>内存结构 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1.程序计数器定义Program Counter Register 程序计数器（寄存器）作用是记住下一条jvm指令的执行地址特点  是线程私有的,每个线程都有自己的程序计数器 不会存在内存溢出的区。  2.虚拟机栈定义Java Virtual Machine Stacks （Java 虚拟机栈）  每个线程运行时所需要的内存，称为虚拟机栈 每个栈由多个栈帧（Frame）组成，对应着每次方法调用时">
<meta property="og:type" content="article">
<meta property="og:title" content="内存结构">
<meta property="og:url" content="https://tukuai.github.io/2020/03/27/JVM-Java%E8%99%9A%E6%8B%9F%E6%9C%BA/%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1.程序计数器定义Program Counter Register 程序计数器（寄存器）作用是记住下一条jvm指令的执行地址特点  是线程私有的,每个线程都有自己的程序计数器 不会存在内存溢出的区。  2.虚拟机栈定义Java Virtual Machine Stacks （Java 虚拟机栈）  每个线程运行时所需要的内存，称为虚拟机栈 每个栈由多个栈帧（Frame）组成，对应着每次方法调用时">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tukuai.github.io/images/161.png">
<meta property="og:image" content="https://tukuai.github.io/images/162.png">
<meta property="og:image" content="https://tukuai.github.io/images/202.png">
<meta property="og:image" content="https://tukuai.github.io/images/163.png">
<meta property="og:image" content="https://tukuai.github.io/images/164.png">
<meta property="og:image" content="https://tukuai.github.io/images/169.png">
<meta property="og:image" content="https://tukuai.github.io/images/170.png">
<meta property="article:published_time" content="2020-03-27T14:08:48.000Z">
<meta property="article:modified_time" content="2020-04-15T03:12:07.207Z">
<meta property="article:author" content="Tukuai">
<meta property="article:tag" content="JVM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tukuai.github.io/images/161.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://Tukuai.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-JVM-Java虚拟机/内存结构" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/27/JVM-Java%E8%99%9A%E6%8B%9F%E6%9C%BA/%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/" class="article-date">
  <time datetime="2020-03-27T14:08:48.000Z" itemprop="datePublished">2020-03-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/JVM/">JVM</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      内存结构
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/161.png" alt=""></p>
<h2 id="1-程序计数器"><a href="#1-程序计数器" class="headerlink" title="1.程序计数器"></a><strong>1.程序计数器</strong></h2><p><strong>定义</strong><br>Program Counter Register 程序计数器（寄存器）<br><strong>作用</strong><br>是记住下一条jvm指令的执行地址<br><img src="/images/162.png" alt=""><br><strong>特点</strong></p>
<ul>
<li>是线程私有的,每个线程都有自己的程序计数器</li>
<li>不会存在内存溢出的区。</li>
</ul>
<h2 id="2-虚拟机栈"><a href="#2-虚拟机栈" class="headerlink" title="2.虚拟机栈"></a><strong>2.虚拟机栈</strong></h2><p><strong>定义</strong><br>Java Virtual Machine Stacks （Java 虚拟机栈）</p>
<ul>
<li>每个线程运行时所需要的内存，称为虚拟机栈</li>
<li>每个栈由多个栈帧（Frame）组成，对应着每次方法调用时所占用的内存</li>
<li>每个线程只能有一个活动栈帧，对应着当前正在执行的那个方法</li>
<li>方法进行依次根据调用情况压栈弹栈，方法内的局部变量在栈内存当中存储。如果通过new创建了对象，在堆内存中的对象的内存地址会被引用在在栈内存中。引用是保存了内存地址的变量。</li>
</ul>
<p><strong>问题辨析</strong></p>
<ol>
<li>垃圾回收是否涉及栈内存？<br>不会，垃圾回收管理的是堆内存中的内存回收</li>
<li>栈内存分配越大越好吗？<br>不是，栈内存越大反而会让线程数越少。因为每个线程都需要一个独立的栈。</li>
<li>方法内的局部变量是否线程安全？<br>如果方法内局部变量没有逃离方法的作用访问，它是线程安全的<br>如果是局部变量引用了对象，并逃离方法的作用范围，需要考虑线程安全</li>
</ol>
<p><strong>如</strong>下面代码中m1是线程安全的，但m2和m3都不是线程安全的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 局部变量的线程安全问题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_17</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();                                                                         </span><br><span class="line">        sb.append(<span class="number">4</span>);</span><br><span class="line">        sb.append(<span class="number">5</span>);</span><br><span class="line">        sb.append(<span class="number">6</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            m2(sb);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sb.append(<span class="number">1</span>);</span><br><span class="line">        sb.append(<span class="number">2</span>);</span><br><span class="line">        sb.append(<span class="number">3</span>);</span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m2</span><span class="params">(StringBuilder sb)</span> </span>&#123;</span><br><span class="line">        sb.append(<span class="number">1</span>);</span><br><span class="line">        sb.append(<span class="number">2</span>);</span><br><span class="line">        sb.append(<span class="number">3</span>);</span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StringBuilder <span class="title">m3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sb.append(<span class="number">1</span>);</span><br><span class="line">        sb.append(<span class="number">2</span>);</span><br><span class="line">        sb.append(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> sb;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>栈内存溢出</strong></p>
<ul>
<li>栈帧过多导致栈内存溢出,StackOverflowError<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示栈内存溢出 java.lang.StackOverflowError</span></span><br><span class="line"><span class="comment"> * -Xss256k</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count;                                                                                                   </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            method1();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(count);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        count++;</span><br><span class="line">        method1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>调用第三方库也可能导致占内存溢出。</li>
<li><em>如*</em>：下方代码，json数据将Dept类转化，但emp和Dept中数据相互引用导致占内存溢出。  需要加上@JsonIgnore。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * json 数据转换</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_19</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;                                                         </span><br><span class="line">        Dept d = <span class="keyword">new</span> Dept();</span><br><span class="line">        d.setName(<span class="string">"Market"</span>);</span><br><span class="line"></span><br><span class="line">        Emp e1 = <span class="keyword">new</span> Emp();</span><br><span class="line">        e1.setName(<span class="string">"zhang"</span>);</span><br><span class="line">        e1.setDept(d);</span><br><span class="line"></span><br><span class="line">        Emp e2 = <span class="keyword">new</span> Emp();</span><br><span class="line">        e2.setName(<span class="string">"li"</span>);</span><br><span class="line">        e2.setDept(d);</span><br><span class="line"></span><br><span class="line">        d.setEmps(Arrays.asList(e1, e2));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#123; name: 'Market', emps: [&#123; name:'zhang', dept:&#123; name:'', emps: [ &#123;&#125;]&#125; &#125;,] &#125;</span></span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        System.out.println(mapper.writeValueAsString(d));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Emp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> Dept dept;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dept <span class="title">getDept</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dept;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDept</span><span class="params">(Dept dept)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dept = dept;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Emp&gt; emps;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Emp&gt; <span class="title">getEmps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> emps;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmps</span><span class="params">(List&lt;Emp&gt; emps)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.emps = emps;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>栈帧过大导致栈内存溢出</li>
</ul>
<p><strong>线程运行诊断</strong><br>案例1： cpu 占用过多<br>linux定位<br>用top定位哪个进程对cpu的占用过高<br>ps H -eo pid,tid,%cpu | grep 进程id （用ps命令进一步定位是哪个线程引起的cpu占用过高）<br>jstack 进程id<br>可以根据线程id(16进制的nid) 找到有问题的线程，进一步定位到问题代码的源码行号</p>
<p>案例2：程序运行很长时间没有结果</p>
<h2 id="3-本地方法栈"><a href="#3-本地方法栈" class="headerlink" title="3.本地方法栈"></a><strong>3.本地方法栈</strong></h2><p>本地方法：java利用调用c或者c++写的实现，以实现对底层操作系统的操作。<br>本地方法调用时所占用的内存空间为本地方法栈</p>
<h2 id="4-堆"><a href="#4-堆" class="headerlink" title="4.堆"></a><strong>4.堆</strong></h2><p><strong>定义</strong><br>Heap 堆<br>创建对象时通过new在堆内存当中开辟了一块新的空间，保存的是实例变量。与栈内存中的内存地址相对应。<br><strong>特点</strong></p>
<ul>
<li>它是线程共享的，堆中对象都需要考虑线程安全的问题</li>
<li>有垃圾回收机制<br><img src="/images/202.png" alt=""></li>
</ul>
<p><strong>堆内存溢出</strong><br>java.lang.OutOfMemoryError: Java heap space</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示堆内存溢出 java.lang.OutOfMemoryError: Java heap space</span></span><br><span class="line"><span class="comment"> * -Xmx8m</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_5</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();                                                                              </span><br><span class="line">            String a = <span class="string">"hello"</span>; </span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                list.add(a); <span class="comment">// hello, hellohello, hellohellohellohello ...</span></span><br><span class="line">                a = a + a;  <span class="comment">// hellohellohellohello</span></span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>堆内存诊断</strong>：在idea，terminal窗口输入指令</p>
<ol>
<li>jps 工具,指令：jps<br>查看当前系统中有哪些 java 进程</li>
<li>jmap 工具<br>查看堆内存占用情况,指令：jmap - heap 进程id</li>
<li>jconsole 工具,指令：jconsole<br>图形界面的，多功能的监测工具，可以连续监测<br>案例<br>垃圾回收后，内存占用仍然很高</li>
<li>jvisualvm工具<br>堆Dump，截取某时刻堆的内存信息，可以查看哪些内存占用过大</li>
</ol>
<h2 id="5-方法区"><a href="#5-方法区" class="headerlink" title="5.方法区"></a><strong>5.方法区</strong></h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a><strong>定义</strong></h3><p>The Java Virtual Machine has a method area that is shared among all Java Virtual Machine threads. The method area is analogous to the storage area for compiled code of a conventional language or analogous to the “text” segment in an operating system process. It stores per-class structures such as the run-time constant pool, field and method data, and the code for methods and constructors, including the special methods (§2.9) used in class and instance initialization and interface initialization.<br><strong>Java虚拟机中有一个被所有jvm线程共享的方法区。方法区有点类似于传统编程语言中的编译代码块或者操作系统层面的代码段。它存储着每个类的构造信息，譬如运行时的常量池，字段，方法数据，以及方法和构造方法的代码，包括一些在类和实例初始化和接口初始化时候使用的特殊方法。</strong></p>
<p>The method area is created on virtual machine start-up. Although the method area is logically part of the heap, simple implementations may choose not to either garbage collect or compact it. This specification does not mandate the location of the method area or the policies used to manage compiled code. The method area may be of a fixed size or may be expanded as required by the computation and may be contracted if a larger method area becomes unnecessary. The memory for the method area does not need to be contiguous.<br><strong>方法区在jvm启动时候被创建。虽然方法区在逻辑层面上是堆的一部分，但是就简单实现来说既不会被回收也不会被压缩。这个规范并不强制指定方法区存放的位置也不会对编译过的代码有管理策略的限制。方法区可能有一个固定的大小或者也可以通过计算大小去扩展也可以在不需要的时候被压缩。方法区的内存也不需要是连续的。</strong></p>
<p>A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of the method area, as well as, in the case of a varying-size method area, control over the maximum and minimum method area size.<br><strong>Jvm虚拟机实现可以提供给编程人员或者用户初始化方法区的大小，同时在方法区可变大小的情况下，控制这个方法区的最大值和最小值。</strong><br>The following exceptional condition is associated with the method area:<br><strong>下面这种异常情况是和方法区有关联的：</strong><br>If memory in the method area cannot be made available to satisfy an allocation request, the Java Virtual Machine throws an OutOfMemoryError.<br><strong>如果方法区满足不了构造所需要的内存，jvm就会抛出OutOfMemoryError。</strong></p>
<h2 id="方法区位置"><a href="#方法区位置" class="headerlink" title="方法区位置"></a><strong>方法区位置</strong></h2><p>元空间是方法区的在 HotSpot JVM 中的实现<br>方法区主要用于存储类信息、常量池、方法数据、方法代码、符号引用等。元空间的本质和永久代类似，都是对 JVM 规范中方法区的实现。不过元空间与永久代之间最大的区别在于：元空间并不在虚拟机中，而是使用本地内存。，理论上取决于32位/64位系统内存大小，可以通过 -XX:MetaspaceSize 和 -XX:MaxMetaspaceSize 配置内存大小。</p>
<h2 id="随JDK版本变迁的方法区"><a href="#随JDK版本变迁的方法区" class="headerlink" title="随JDK版本变迁的方法区"></a><strong>随JDK版本变迁的方法区</strong></h2><p><strong>JDK6</strong><br>Klass 元数据信息<br>每个类的运行时常量池（字段、方法、类、接口等符号引用）、编译后的代码<br>静态字段（无论是否有final）在 instanceKlass 末尾（位于 PermGen 内）<br>oop（Ordinary Object Pointer（普通对象指针）） 其实就是 Class 对象实例<br>全局字符串常量池 StringTable，本质上就是个 Hashtable<br>符号引用（类型指针是 SymbolKlass）</p>
<p><strong>JDK7</strong><br>Klass 元数据信息<br>每个类的运行时常量池（字段、方法、类、接口等符号引用）、编译后的代码<br>静态字段从 instanceKlass 末尾移动到了 java.lang.Class 对象（oop）的末尾（位于 Java Heap 内）<br>oop 与全局字符串常量池移到 Java Heap 上<br>符号引用被移动到 Native Heap 中</p>
<p><strong>JDK8</strong><br>移除永久代<br>Klass 元数据信息<br>每个类的运行时常量池、编译后的代码移到了另一块与堆不相连的本地内存 – 元空间（Metaspace）</p>
<h3 id="组成"><a href="#组成" class="headerlink" title="组成"></a><strong>组成</strong></h3><p><img src="/images/163.png" alt=""></p>
<h3 id="方法区内存溢出"><a href="#方法区内存溢出" class="headerlink" title="方法区内存溢出"></a><strong>方法区内存溢出</strong></h3><p>1.8 以前会导致永久代内存溢出</p>
<ul>
<li>演示永久代内存溢出 java.lang.OutOfMemoryError: PermGen space * -XX:MaxPermSize=8m</li>
</ul>
<p>1.8 之后会导致元空间内存溢出  java.lang.OutOfMemoryError: Metaspace</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示元空间内存溢出 java.lang.OutOfMemoryError: Metaspace</span></span><br><span class="line"><span class="comment"> * -XX:MaxMetaspaceSize=8m</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_8</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123; <span class="comment">// 可以用来加载类的二进制字节码</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Demo1_8 test = <span class="keyword">new</span> Demo1_8();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++, j++) &#123;</span><br><span class="line">                <span class="comment">// ClassWriter 作用是生成类的二进制字节码</span></span><br><span class="line">                ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 版本号， public， 类名, 包名, 父类， 接口      </span></span><br><span class="line">                cw.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, <span class="string">"Class"</span> + i, <span class="keyword">null</span>, <span class="string">"java/lang/Object"</span>, <span class="keyword">null</span>);                                    </span><br><span class="line">                <span class="comment">// 返回 byte[]</span></span><br><span class="line">                <span class="keyword">byte</span>[] code = cw.toByteArray();</span><br><span class="line">                <span class="comment">// 执行了类的加载</span></span><br><span class="line">                test.defineClass(<span class="string">"Class"</span> + i, code, <span class="number">0</span>, code.length); <span class="comment">// Class 对象</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>场景</strong></p>
<ul>
<li>spring和mybatis:<br>cglib,动态生成类字节码，动态的类加载，代理技术中广泛运用的，会大量生成运行时的类。</li>
</ul>
<h3 id="运行时常量池"><a href="#运行时常量池" class="headerlink" title="运行时常量池"></a><strong>运行时常量池</strong></h3><p>二进制字节码:(类基本信息，常量池，类自定义方法，包含了虚拟机指令)<br>原类内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> t5;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 二进制字节码（类基本信息，常量池，类方法定义，包含了虚拟机指令）                                 </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello world"</span>);                                                                                              </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在terminal控制台输入指令：javap-v HelloWorld.class  可以对二进制字节码进行反编译。class文件在out里</p>
<hr>
<pre><code>            D:\IdeaProjects\basic-code\jvm\out\production\jvm\t5&gt;javap -v HelloWorld.class
类基本信息
            Classfile /D:/IdeaProjects/basic-code/jvm/out/production/jvm/t5/HelloWorld.class
            Last modified 2020-3-29; size 539 bytes
            MD5 checksum 7dede3a2ea79b7095ea4e895d2a766b1
            Compiled from &quot;HelloWorld.java&quot;
            public class t5.HelloWorld
            minor version: 0
            major version: 52
            flags: ACC_PUBLIC, ACC_SUPER
常量池
            Constant pool:
               #1 = Methodref          #6.#20         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V
               #2 = Fieldref           #21.#22        // java/lang/System.out:Ljava/io/PrintStream;
               #3 = String             #23            // hello world
               #4 = Methodref          #24.#25        // java/io/PrintStream.println:(Ljava/lang/String;)V
               #5 = Class              #26            // t5/HelloWorld
               #6 = Class              #27            // java/lang/Object
               #7 = Utf8               &lt;init&gt;
               #8 = Utf8               ()V
               #9 = Utf8               Code
              #10 = Utf8               LineNumberTable
              #11 = Utf8               LocalVariableTable
              #12 = Utf8               this
              #13 = Utf8               Lt5/HelloWorld;
              #14 = Utf8               main
              #15 = Utf8               ([Ljava/lang/String;)V
              #16 = Utf8               args
              #17 = Utf8               [Ljava/lang/String;
              #18 = Utf8               SourceFile
              #19 = Utf8               HelloWorld.java
              #20 = NameAndType        #7:#8          // &quot;&lt;init&gt;&quot;:()V
              #21 = Class              #28            // java/lang/System
              #22 = NameAndType        #29:#30        // out:Ljava/io/PrintStream;
              #23 = Utf8               hello world
              #24 = Class              #31            // java/io/PrintStream
              #25 = NameAndType        #32:#33        // println:(Ljava/lang/String;)V
              #26 = Utf8               t5/HelloWorld
              #27 = Utf8               java/lang/Object
              #28 = Utf8               java/lang/System
              #29 = Utf8               out
              #30 = Utf8               Ljava/io/PrintStream;
              #31 = Utf8               java/io/PrintStream
              #32 = Utf8               println
              #33 = Utf8               (Ljava/lang/String;)V
类的方法定义   
              {
                public t5.HelloWorld();  
                descriptor: ()V
                flags: ACC_PUBLIC
                Code:
                  stack=1, locals=1, args_size=1
                     0: aload_0
                     1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V
                     4: return
                  LineNumberTable:
                    line 4: 0
                  LocalVariableTable:
                    Start  Length  Slot  Name   Signature
                        0       5     0  this   Lt5/HelloWorld;
              public static void main(java.lang.String[]);
                descriptor: ([Ljava/lang/String;)V
                flags: ACC_PUBLIC, ACC_STATIC
    虚拟机指令
                Code:
                  stack=2, locals=1, args_size=1
    获取静态变量      0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
    加载参数          3: ldc           #3                  // String hello world
    虚方法调用        5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
    执行结束          8: return
                  LineNumberTable:
                    line 6: 0
                    line 7: 8
                  LocalVariableTable:
                    Start  Length  Slot  Name   Signature
                        0       9     0  args   [Ljava/lang/String;
            }
            SourceFile: &quot;HelloWorld.java&quot;</code></pre><hr>
<p><strong>常量池：</strong>就是一张表，虚拟机指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量等信息<br>运行时常量池：常量池是 * .class 文件中的，当该类被加载，它的常量池信息就会放入运行时常量池，并把里面的符号地址变为真实地址<br><strong>StringTable</strong>,<br>StringTable[]底层是一个不能扩容的hash表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// StringTable [ "a", "b" ,"ab" ]  hashtable 结构，不能扩容</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_22</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 常量池中的信息，都会被加载到运行时常量池中， 这时 a b ab 都是常量池中的符号，还没有变为 java 字符串对象</span></span><br><span class="line">    <span class="comment">// ldc #2 会把 a 符号变为 "a" 字符串对象(先在串池里面找，里面没有就放入串池，如果串池里面已经有了就会使用串池里面的对象)</span></span><br><span class="line">    <span class="comment">// ldc #3 会把 b 符号变为 "b" 字符串对象</span></span><br><span class="line">    <span class="comment">// ldc #4 会把 ab 符号变为 "ab" 字符串对象</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String s1 = <span class="string">"a"</span>; <span class="comment">// 懒惰的</span></span><br><span class="line">        String s2 = <span class="string">"b"</span>;</span><br><span class="line">        String s3 = <span class="string">"ab"</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        0: ldc           #2                  // String a</span></span><br><span class="line"><span class="comment">         2: astore_1</span></span><br><span class="line"><span class="comment">         3: ldc           #3                  // String b</span></span><br><span class="line"><span class="comment">         5: astore_2</span></span><br><span class="line"><span class="comment">         6: ldc           #4                  // String ab</span></span><br><span class="line"><span class="comment">         8: astore_3</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String s4 = s1 + s2;     </span><br><span class="line">        <span class="comment">// new StringBuilder().append("a").append("b").toString()  new String("ab")</span></span><br><span class="line">        <span class="comment">/* </span></span><br><span class="line"><span class="comment">        9: new           #5                  // class java/lang/StringBuilder</span></span><br><span class="line"><span class="comment">        12: dup</span></span><br><span class="line"><span class="comment">        13: invokespecial #6                  // Method java/lang/StringBuilder."&lt;init&gt;":()V</span></span><br><span class="line"><span class="comment">        16: aload_1                           // 将s1加载</span></span><br><span class="line"><span class="comment">        17: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span></span><br><span class="line"><span class="comment">        20: aload_2</span></span><br><span class="line"><span class="comment">        21: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span></span><br><span class="line"><span class="comment">        24: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span></span><br><span class="line"><span class="comment">        27: astore        4</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        System.out.println(s3 == s4);<span class="comment">//false</span></span><br><span class="line">        String s5 = <span class="string">"a"</span> + <span class="string">"b"</span>;  <span class="comment">// javac 在编译期间的优化，结果已经在编译期确定为ab</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         29: ldc           #4                  // String ab</span></span><br><span class="line"><span class="comment">        31: astore        5</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        System.out.println(s3 == s5);<span class="comment">//true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反编译结果：</p>
<pre><code>Code:
  stack=3, locals=6, args_size=1
     0: ldc           #2                  // String a
     2: astore_1
     3: ldc           #3                  // String b
     5: astore_2
     6: ldc           #4                  // String ab
     8: astore_3
     9: new           #5                  // class java/lang/StringBuilder
    12: dup
    13: invokespecial #6                  // Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V
    16: aload_1                           // 将s1加载
    17: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
    20: aload_2
    21: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
    24: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
    27: astore        4
    29: ldc           #4                  // String ab
    31: astore        5
    33: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;
    36: aload_3
    37: aload         5
    39: if_acmpne     46
    42: iconst_1
    43: goto          47
    46: iconst_0
    47: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V
    50: return
  LineNumberTable:
    line 11: 0
    line 12: 3
    line 13: 6
    line 14: 9
    line 15: 29
    line 17: 33
    line 21: 50
  LocalVariableTable:
    Start  Length  Slot  Name   Signature
        0      51     0  args   [Ljava/lang/String;
        3      48     1    s1   Ljava/lang/String;
        6      45     2    s2   Ljava/lang/String;
        9      42     3    s3   Ljava/lang/String;
       29      22     4    s4   Ljava/lang/String;
       33      18     5    s5   Ljava/lang/String;
      }</code></pre><p><strong>原因</strong>：s1和s2都是变量，在编译期间不能得知s1+s2的最终结果，但”a”+”b”是常量在编译期间可以得出其结果，所以编译优化直接使其指向串池中已有的常量。<br><strong>结论</strong>：1.8：动态拼接的字符串不会放入串池中，而是在堆中，字符串调用inner方法，会将该字符串放入串池，如果有则不会放，而是返回串池中值相同的字符串对象。<br>1.6：动态拼接的字符串不会放入串池中，而是在堆中，字符串调用inner方法，会将该字符串<strong>复制后</strong>放入串池，如果有则不会放，而是返回串池中值相同的字符串对象。</p>
<p>常量池中的字符串仅是符号，第一次调到时才变为对象<br>利用串池的机制，来避免重复创建字符串对象<br>字符串变量拼接的原理是 StringBuilder （1.8）<br>字符串常量拼接的原理是编译期优化<br>可以使用 intern 方法，主动将串池中还没有的字符串对象放入串池<br>1.8 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回<br>1.6 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有会把此对象复制一份，放入串池， 会把串池中的对象返回<br><strong>面试题</strong><br><strong>String s1 = “a”;<br>String s2 = “b”;<br>String s3 = “a” + “b”;<br>String s4 = s1 + s2;<br>String s5 = “ab”;<br>String s6 = s4.intern();<br>// 问<br>System.out.println(s3 == s4);<br>System.out.println(s3 == s5);<br>System.out.println(s3 == s6);<br>String x2 = new String(“c”) + new String(“d”);<br>String x1 = “cd”;<br>x2.intern();<br>// 问，如果调换了【最后两行代码】的位置呢，如果是jdk1.6呢<br>System.out.println(x1 == x2)</strong><br><strong><em>答案</em></strong>：false，true，true，false<br>如果调换位置：false，true，true，true<br>1.6：false，true，true，false</p>
<p><strong>StringTable 位置</strong><br><strong>1.6：</strong>在常量池中，常量池(包含于方法区中)在永久代中；<br><strong>1.7及以后：</strong>在堆中，方法区在元空间<br><strong>原因</strong>：永久代的内存回收效率很低，永久在需要等到老年代空间不足才能回收，触发事件太晚，但StringTable经常使用，很容易导致永久代内存不足。<br><img src="/images/164.png" alt=""></p>
<p><strong>StringTable 垃圾回收</strong><br>若StringTable中字符串数量较多时会调用垃圾回收。<br><strong>StringTable 性能调优</strong><br>主要是调整hashtable的桶的个数，桶较多时散列查询和存放速度会比较快，因为每个链表个数会较短，而链表的删和查是与链表长度直接关联的。<br>调整 -XX:StringTableSize=桶个数<br><strong>考虑将字符串对象是否入池</strong><br>若字符串重复过多，入池则会大大提高内存效率。</p>
<h2 id="直接内存"><a href="#直接内存" class="headerlink" title="直接内存"></a><strong>直接内存</strong></h2><p><strong>定义</strong></p>
<ul>
<li>Direct Memory</li>
<li>常见于 NIO 操作时，用于数据缓冲区,ByteBuffer.allocateDirect()使用的就是直接内存。其底层是调用Unsafe对象的allocateMemory()方法.</li>
<li>分配回收成本较高，但读写性能高</li>
<li>不受 JVM 内存回收管理，所以不是通过GC垃圾回收的，而是通过Unsafe类中的freeMemory完成的。</li>
</ul>
<p><strong>不使用直接内存的情况</strong><br>由于系统内存java代码不能直接访问，所以需要再次复制到java堆内存中，存在多余的操作。<br><img src="/images/169.png" alt=""><br><strong>使用直接内存的情况</strong><br>java代码可以直接操作Direct Memory，所以省去了复制到java堆的过程。<br><img src="/images/170.png" alt=""></p>
<p><strong>分配和回收原理</strong></p>
<ul>
<li>使用了 Unsafe 对象完成直接内存的分配回收，并且回收需要主动调用 freeMemory 方法。</li>
<li>ByteBuffer 的实现类内部，使用了 Cleaner （虚引用）来监测 ByteBuffer 对象，一旦ByteBuffer 对象被垃圾回收，那么就会由 ReferenceHandler 线程通过Cleaner 的clean方法简介调用 freeMemory 来释放直接内存。</li>
<li>一般使ByteBuffer为null时，还需要调用Unsafe类中的freeMemory来手动回收掉这部分没对象指向的内存。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tukuai.github.io/2020/03/27/JVM-Java%E8%99%9A%E6%8B%9F%E6%9C%BA/%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/" data-id="ckb22iudp001qzwu80mdvgx4r" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JVM/" rel="tag">JVM</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/03/28/Web/JQuery%E5%9F%BA%E7%A1%80/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          JQuery基础
        
      </div>
    </a>
  
  
    <a href="/2020/03/27/JVM-Java%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM%E5%85%A5%E9%97%A8/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">JVM入门</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/IO/">IO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E8%BF%9B%E9%98%B6/">Java进阶</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode/">LeetCode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">并发编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/">面向对象</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/" rel="tag">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/" rel="tag">LeetCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/JVM/" style="font-size: 12.86px;">JVM</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/LeetCode/" style="font-size: 11.43px;">LeetCode</a> <a href="/tags/Web/" style="font-size: 18.57px;">Web</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 17.14px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 14.29px;">数据结构</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15.71px;">算法</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 11.43px;">计算机网络</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 14.29px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/06/05/%E6%95%B0%E6%8D%AE%E5%BA%93/WHERE%E5%92%8CON%E7%9A%84%E5%8C%BA%E5%88%AB/">数据库/WHERE和ON的区别</a>
          </li>
        
          <li>
            <a href="/2020/06/05/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%B5%8B%E8%AF%95/">操作系统/测试</a>
          </li>
        
          <li>
            <a href="/2020/06/05/Java%E5%9F%BA%E7%A1%80/HashMap/">Java基础/HashMap</a>
          </li>
        
          <li>
            <a href="/2020/05/23/Redis/%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">企业级解决方案</a>
          </li>
        
          <li>
            <a href="/2020/05/23/Redis/Redis%E9%9B%86%E7%BE%A4/">Redis集群</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Tukuai<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>